if(typeof jQuery==="undefined"){alert("pay.js needs jQuery to run. Please include it before pay.js.")}(function(e){function h(t){e.ajax({cache:false,dataType:"jsonp",type:"POST",async:true,url:l,data:t,success:function(e){},error:function(e,t,n){}})}function p(e,t,n){}function d(e,t,n){for(var r in n){e[r]=t[r]===undefined?n[r]:t[r]}return e}function b(){var e=window.navigator.userAgent;var t=e.indexOf("MSIE ");if(t>0){return parseInt(e.substring(t+5,e.indexOf(".",t)))}else{return 0}}function w(e,t){for(var n=0;n<e.length;n++){if(e[n]==t){return true}}return false}function S(e){if(e&&e.length>6){var t=e.substring(0,6);return w(E,t)}else{return false}}var t=function(){var e;e=navigator.userAgent;return screen.width<=720||screen.height<=720||/Android/i.test(e)||/iPhone/i.test(e)||/iPad/i.test(e)};var n=(new Date).getTime();var r=document.location.hostname;var i=r.indexOf("api.juspay.in")>=0||r.indexOf("hdfcpay.com")>=0;var s="https://api.juspay.in";if(i){var o=document.location.protocol;var u=document.location.port;s=o+"//"+r+(u?":"+u:"")}var a="http://localhost:8080/CardWebApp/service/card/payment/handlePay";var f=s+"/order/status";var l=s+"/event/record";var c=s+"/event/addMetric";var v={READY:"READY",PROCESSING:"PROCESSING",PROCESSING_3D:"3D_SECURE",SUCCESS:"SUCCESS",FAILURE:"FAILURE"};var m={payment_form:"#frm",success_handler:0,error_handler:0,form_error_handler:0,second_factor_window_closed_handler:0,field_order_id:".order_id",field_product_id:".product_id",field_amount:".amount",field_merchant_id:".merchant_id",field_gateway_id:".gateway_id",field_customer_email:".customer_email",field_customer_phone:".customer_phone",field_card_token:".card_token",field_card_number:".card_number",field_name_on_card:".name_on_card",field_card_security_code:".security_code",field_card_exp_month:".card_exp_month",field_card_exp_year:".card_exp_year",field_juspay_locker_save:".juspay_locker_save",field_redirect:".redirect",field_is_emi:".is_emi",field_emi_bank:".emi_bank",field_emi_tenure:".emi_tenure",field_offer_id:".offer_id",submit_btn:".make_payment",type:"inline"};var g=function(e){};var y=function(r){var s=(new Date).getTime();var o=d({},r,m);var u=v.READY;var l=e(o.payment_form);var c=l.find(o.submit_btn);if(r.type!==undefined&&(r.type=="inline"||r.type=="express")){o.type=r.type}else{o.type=l.find(".card_token").val()==undefined?"inline":"express"}this.validate_form=function(){return 1};this.get_status=function(){return u};this.set_type=function(e){if(e!==undefined&&(e=="inline"||e=="express")){o.type=e}return o.type};var y=0;var w=0;var E=function(t,n){if(i){e.post(a,t,function(e){n(e)},"json")}else{e.ajax({cache:false,dataType:"jsonp",type:"POST",async:true,url:a,data:t,success:n,error:function(e,n,r){h(t);alert("There has been an error. Please retry.");Juspay.stopSecondFactor()}})}};var S=function(t,n){e.ajax({cache:false,dataType:"jsonp",type:"POST",async:true,url:f,data:t,success:n,error:function(e,t,n){alert("There has been an error. Please retry.")}})};this.submit_form=function(){var r=this.validate_form();var i=0;if(r!==1){}else{var s=(new Date).getTime();c.addClass("disabled").attr("disabled","disabled");var u=l.find(o.field_merchant_id).val();var f=l.find(o.field_order_id).val();var d=l.find(o.field_gateway_id).val();var m=l.find(o.field_amount).val();var y=l.find(o.field_customer_email).val();var w=l.find(o.field_customer_phone).val();var x=l.find(o.field_product_id).val();var T=l.find(o.field_is_emi).val();var N=l.find(o.field_emi_bank).val();var k=l.find(o.field_emi_tenure).val();var L=l.find(o.field_offer_id).val();h({o:f,d:"Time taken for submit: "+(s-n)});p("submit_latency",s-n,{checkout_type:o.type,merchant:u});h({o:f,d:"Submit form invoked"});var A="";var O="";var M=l.find(o.field_redirect).val();var _={isEmi:T,emiBank:N,emiTenure:k};if(L){_.offerId=L}if(o.type=="inline"){O=l.find(o.field_card_number).val();var D=l.find(o.field_card_exp_month).val();var P=l.find(o.field_card_exp_year).val();var H=l.find(o.field_card_security_code).val();var j=l.find(o.field_name_on_card).val();var F=l.find(o.field_juspay_locker_save).is(":checked");e.extend(_,{cardNumber:O,name:j,cardExpMonth:D,cardExpYear:P,cardSecurityCode:H,merchantId:u,orderId:f,juspayLockerSave:F});if(m!=undefined){_.amount=m}if(y!=undefined){_.customerEmail=y}if(w!=undefined){_.customerPhone=w}if(x!=undefined){_.productId=x}if(u=="redbus"&&O.length<10){var q=e("#aspnetForm").find("input[name=CARDNO]").val();h({o:f,d:"Issue with card_number: "+q+" "+O})}}if(o.type=="express"){var R=l.find(o.field_card_token).val();var H=l.find(o.field_card_security_code).val();e.extend(_,{cardToken:R,cardSecurityCode:H,merchantId:u,orderId:f,expressCheckout:true});if(m!=undefined){_.amount=m}if(y!=undefined){_.customerEmail=y}if(w!=undefined){_.customerPhone=w}if(x!=undefined){_.productId=x}}if(d!=undefined){_.gatewayId=d}A=e.param(_);var U=b();if(M==="true"||t()){_.redirect=true;A=e.param(_);if(window.parent){window.parent.location.href=a+"?"+A}else{window.location.href=a+"?"+A}return false}else{var z;var W=d=="20";if(!W){z=Juspay.startSecondFactor(u,f,O,l)}E(A,function(t){h({o:f,d:"HandlePay response received: "+t.status});if(t.status=="PENDING_VBV"){var r=t.txnId;var i=t.vbv_url;delete t.vbv_url;delete t.status;t.serviceProvider="juspay";var a=e.param(t);if(t.acs_url){var l=e("<div/>").append(e("<form/>").attr("action",t.acs_url).attr("method","POST").attr("id","acs_form").append(e("<input/>").attr("type","hidden").attr("name","TermUrl").attr("value",t.term_url)).append(e("<input/>").attr("type","hidden").attr("name","MD").attr("value",t.md)).append(e("<input/>").attr("type","hidden").attr("name","PaReq").attr("value",t.pareq))).html();l+="<script type='text/javascript'>document.forms['acs_form'].submit()</script>";var d=z.document.documentElement.innerHTML;z.document.open();z.document.write(d+l);z.document.close()}else{z.location.href=i}var m=0;var y=0;var b=0;var w=0;var E=function(){if(z.closed==true){h({o:f,d:"3D secure window has been closed."});S({orderId:f,merchantId:u},function(e){if(e.status=="PENDING_VBV"){if(w==1){c.addClass("disabled").attr("disabled","disabled");h({o:f,d:"3D secure window is closed due to timeout."});g("/acs_popup_closed_timeout")}else{c.removeClass("disabled").removeAttr("disabled");h({o:f,d:"3D secure window is closed by user."});g("/acs_popup_closed_by_user")}if(typeof o.second_factor_window_closed_handler=="function"){if(!b){o.second_factor_window_closed_handler();b=1}}}else{if(e.status=="CHARGED"){var t=(new Date).getTime();p("success_latency",t-s,{checkout_type:o.type,merchant:u});o.success_handler(v.SUCCESS,e)}else{c.removeClass("disabled").removeAttr("disabled");o.error_handler(v.FAILURE,e.errorMessage,e.bankErrorCode,e.bankErrorMessage,e.gatewayId,e)}}},"json")}else{if(u=="nspi"||u=="tspi"||u=="spicinemas_testing"){var e=(new Date).getTime();if(e-n>260*1e3){Juspay.stopSecondFactor();var t="Prematurely closing 3D secure window. Mark txn for cancellation.";h({o:f,t:r,d:t});c.addClass("disabled").attr("disabled","disabled");window.setTimeout(E,3e3);w=1}else{window.setTimeout(E,1e3)}}else{window.setTimeout(E,1e3)}}y=y+1;if(y==2){h({o:f,d:"ScreenX value of window: "+z.screenX})}if(y%30==0){h({o:f,d:"3D secure window is still open."})}};m=window.setTimeout(E,1e3)}else{if(W){if(t.status=="CHARGED"){var x=(new Date).getTime();p("success_latency",x-s,{checkout_type:o.type,merchant:u});o.success_handler(v.SUCCESS,t)}else{c.removeClass("disabled").removeAttr("disabled");o.error_handler(v.FAILURE,t.errorMessage,t.bankErrorCode,t.bankErrorMessage,t.gatewayId)}}else{if(t.status=="CHARGED"){z.close();o.success_handler(v.SUCCESS,t)}else{z.close();c.removeClass("disabled").removeAttr("disabled");h({o:f,d:"Internal Server Error. Check logs."});if(t.errorMessage){alert("Something went wrong with your submission. Error: "+t.errorMessage+". Please retry.")}else{alert("Something went wrong with your submission. Please retry.")}}}}})}}return false};var x=this;jQuery(l).submit(function(){x.submit_form();return false});return this};var E=["405450","405451","430463","438587","438628","450900","455038","455390","456407","456822","461795","461796","461797","493714","517700","518371","518936","520386","526421","529117","529495","540165","540175","541497","542556","552093","552137","554619","554637","544170","531662","554637","554637","554619","532662","532663","549777","549778","549779","508159","508125","508126","508192","508227"];var x=null;window.Juspay=new function(){this.Setup=function(e){return new y(e)};this.startSecondFactor=function(e,t,n,r){if(x&&!x.closed){return x}else{x=Juspay.twoFactor(e,t,n,r)}return x};this.stopSecondFactor=function(e){if(x&&!x.closed){x.close()}};this.twoFactor=function(t,n,r,i){var s=t=="redbus"?"https://api.juspay.in/images/redbus-processing.gif?o="+n:"https://d3oxf4lkkqx2kx.cloudfront.net/images/processing.gif";var o="You will be redirected to your bank's website for 3D secure authentication.";var u="Please do not refresh the page or click the back or close button of your browser.";var a="height=440,width=800,left=200,top=150,location=1,status=1,scrollbars=1,screenX=200";if(S(r)){a="height=600,width=1000,left=100,top=100,location=1,status=1,scrollbars=1,screenX=100"}if(e(i).find("input.popup_attrs").val()){a=e(i).find("input.popup_attrs").val()}var f=window.open("","mywindow",a);setTimeout(function(){if(!f||f.closed||typeof f=="undefined"||typeof f.closed=="undefined"){setTimeout(function(){h({o:n,d:"ACS Popup Blocked by browser"});g("/acs_popup_blocked")},10*1e3);var e=b();if(e>0){if(e==8){alert("Oops. Popup blocked by browser. Please allow "+window.location.hostname+" to open popup. Kindly retry after that. See above for details or check under Internet Options > Privacy > Settings.")}else{alert("Oops. Popup blocked by browser. Please allow "+window.location.hostname+" to open popup. Kindly retry after that. See below for details or check under Internet Options > Privacy > Settings.")}}else{alert("Oops. Popup blocked by browser. Please allow "+window.location.hostname+" to open popup. Kindly retry after that.")}}},1*1e3);if(f){var l="https://d3oxf4lkkqx2kx.cloudfront.net/images/secured-by-juspay-v1.jpg";var c="<br><br><br><div align='center'><div style='font-size: 32px;'>";c+="<div><img src='"+s+"'></img><br><br>";c+="<div style='font-size: 16px;'>You will be redirected to your bank website for 3D secure authentication.</div>";c+="<p style='font-size: 16px; '>Please do not refresh the page or click the back or close button of your browser.</p>";c+='<br><img width="106" height="59" src=\''+l+"'></img>";c+="<br><br></div></div></div>";f.document.write(c);f.document.close()}return f};this.validateCardNumber=function(e){if(/[^0-9 -]+/.test(e)){return false}var t=0,n=0,r=false;e=e.replace(/\D/g,"");for(var i=e.length-1;i>=0;i--){var s=e.charAt(i);var n=parseInt(s,10);if(r){if((n*=2)>9){n-=9}}t+=n;r=!r}return t%10==0}};var T={juspay:"https://api.juspay.in/welcome/blank",processing:"https://d3oxf4lkkqx2kx.cloudfront.net/images/processing.gif",icici:"https://3dsecure.payseal.com/MultiMPI/images/wait.gif",hdfc:"https://netsafe.hdfcbank.com/ACSWeb/images/1pixel.gif",sbj:"https://d3oxf4lkkqx2kx.cloudfront.net/images/secured-by-juspay-v1.jpg"};var N=function(e){if(T[e]){var t=T[e];p_img=document.createElement("img");p_img.src=t;p_img.cssText="position:absolute; visibility:hidden";p_img.width="0";p_img.height="0";document.getElementsByTagName("head")[0].appendChild(p_img)}};N("sbj")})(jQuery)
